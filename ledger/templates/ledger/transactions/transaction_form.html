{% extends "index.html" %}
{% load crispy_forms_tags %}

{% block title %}{% if object %}Edit Transaction{% else %}Add TEST{% endif %} | MoneyPro{% endblock %}

{% block content %}
<div class="container-fluid px-2 px-md-3 py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h4 mb-0">{% if object %}Edit Transaction{% else %}Add Transaction{% endif %}</h1>
      <div class="text-muted small">Track income and expenses with optional job + payee links.</div>
    </div>
    <a class="btn btn-outline-secondary" href="{% url 'ledger:transaction_list' %}">Back</a>
  </div>

  <div class="card shadow-sm">
    <div class="card-body p-3 p-md-4">
      <form method="post" novalidate>
        {% csrf_token %}

        {% if form.non_field_errors %}
          <div class="alert alert-danger">{{ form.non_field_errors }}</div>
        {% endif %}

        {{ form|crispy }}

        <div class="d-grid d-sm-flex gap-2 justify-content-sm-end mt-3">
          <a class="btn btn-outline-secondary w-100 w-sm-auto py-2"
            href="{% url 'ledger:transaction_list' %}">Cancel</a>
          <button type="submit" class="btn btn-primary w-100 w-sm-auto py-2">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
(function () {
  const subSel = document.getElementById("id_subcategory");
  const payeeSel = document.getElementById("id_payee");
  const payeeWrap = document.getElementById("payeeWrap");
  const transportWrap = document.getElementById("transportWrap");

  function applyRules() {
    if (!subSel) return;

    const opt = subSel.options[subSel.selectedIndex];
    if (!opt) return;

    const payeeRole = (opt.dataset.payeeRole || "any").toLowerCase();
    const requiresTransport = opt.dataset.requiresTransport === "1";

    if (payeeWrap) payeeWrap.style.display = "";
    if (transportWrap) transportWrap.style.display = requiresTransport ? "" : "none";

        if (!requiresTransport) {
      const transport = document.getElementById("id_transport_selector");
      if (transport) transport.value = "";
    }

    if (payeeSel) {
      for (const pOpt of payeeSel.options) {
        if (!pOpt.value) continue;

        let show = true;
        if (payeeRole === "contractor") show = pOpt.dataset.isContractor === "1";
        else if (payeeRole === "vendor") show = pOpt.dataset.isVendor === "1";
        else if (payeeRole === "customer") show = pOpt.dataset.isCustomer === "1";

        pOpt.hidden = !show;
        if (!show && pOpt.selected) payeeSel.value = "";
      }
    }
  }

  if (subSel) {
    subSel.addEventListener("change", applyRules);
    applyRules();
  }
})();
</script>
{% endblock %}
