{% extends "index.html" %}
{% load humanize %}

{% block title %}Dashboard | MoneyPro{% endblock %}

{% block content %}
<div class="container-fluid px-2 px-md-3 py-3">

  <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-3">
    <div>
      <h1 class="h4 mb-0">Dashboard</h1>
      <div class="text-muted small">Welcome back, {{ request.user.email|default:request.user.get_username }}</div>
    </div>

    
<div class="d-flex gap-2 flex-wrap align-items-center">

  <div class="btn-group btn-group-sm" role="group" aria-label="Chart period">
    <input type="radio" class="btn-check" name="periodMode" id="modeRolling" autocomplete="off" checked>
    <label class="btn btn-outline-secondary" for="modeRolling">Rolling 12</label>

    <input type="radio" class="btn-check" name="periodMode" id="modeYear" autocomplete="off">
    <label class="btn btn-outline-secondary" for="modeYear">Year</label>
  </div>

  <label for="yearSelect" class="visually-hidden">Year</label>
  <select id="yearSelect" class="form-select form-select-sm" style="min-width: 110px;" {% if not years %}disabled{% endif %}>
    {% for y in years %}
      <option value="{{ y }}">{{ y }}</option>
    {% endfor %}
  </select>

  <form method="post" action="{% url 'dashboard:seed_defaults' %}" class="d-inline">
    {% csrf_token %}
    <button type="submit" class="btn btn-outline-primary btn-sm">
      {% if has_seeded %}Re-Seed{% else %}Seed{% endif %}
    </button>
  </form>

  <a class="btn btn-primary btn-sm" href="{% url 'ledger:transaction_create' %}">+ Add Transaction</a>
</div>
</div>


  <div class="row g-3 mb-3">
    <div class="col-12 col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="text-muted small">Income (<span id="periodLabel">{{ period_label }}</span>)</div>
          <div class="fs-4 fw-semibold" id="incomeTotal">${{ income_total|floatformat:2|intcomma }}</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="text-muted small">Expenses (<span id="periodLabel2">{{ period_label }}</span>)</div>
          <div class="fs-4 fw-semibold" id="expenseTotal">${{ expense_total|floatformat:2|intcomma }}</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="text-muted small">Net (<span id="periodLabel3">{{ period_label }}</span>)</div>
          <div class="fs-4 fw-semibold" id="netTotal">${{ net_total|floatformat:2|intcomma }}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body p-3 p-md-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 mb-0">Monthly Income vs Expenses</h2>
        <div class="text-muted small" id="chartPeriodLabel">{{ period_label }}</div>
      </div>
      <div style="height: 280px;">
        <canvas id="incomeExpenseChart"></canvas>
      </div>
      <div class="text-muted small mt-3">
        Tip: expenses are shown as positive values (refunds reduce totals).
      </div>
    </div>
  </div>

  <div class="card shadow-sm mt-3">
    <div class="card-body p-3 p-md-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 mb-0">Recent transactions</h2>
        <a class="small text-decoration-none" href="{% url 'ledger:transaction_list' %}">View all</a>
      </div>

      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead>
            <tr>
              <th>Date</th>
              <th>Description</th>
              <th class="d-none d-md-table-cell">Team</th>
              <th class="d-none d-md-table-cell">Subcategory</th>
              <th class="text-end">Amount</th>
            </tr>
          </thead>
          <tbody>
            {% for t in recent_transactions %}
              <tr>
                <td class="text-nowrap">{{ t.date }}</td>
                <td>
                  <div class="d-flex align-items-center gap-2"><div class="fw-semibold">{{ t.description }}</div>{% if t.trans_type == "income" %}<span class="badge rounded-pill text-bg-success">Income</span>{% endif %}</div>
                  <div class="text-muted small d-md-none">
                    {% if t.team %}{{ t.team.name }} · {% endif %}{{ t.subcategory.name }}
                  </div>
                </td>
                <td class="d-none d-md-table-cell">{% if t.team %}{{ t.team.name }}{% else %}—{% endif %}</td>
                <td class="d-none d-md-table-cell">{{ t.subcategory.name }}</td>
                <td class="text-end {% if t.trans_type == "income" %}text-success{% else %}text-body{% endif %}">
                  {% if t.is_refund %}-{% endif %}${{ t.amount|floatformat:2|intcomma }}
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="5" class="text-muted">No transactions yet.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  (function () {
    const chartDataUrl = "{% url 'dashboard:chart_data' %}";

    const fmtMoney = (n) => {
      try { return "$" + Number(n || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}); }
      catch (e) { return "$0.00"; }
    };

    const labels0 = {{ chart_labels_json|safe }};
    const income0 = {{ chart_income_json|safe }};
    const expenses0 = {{ chart_expense_json|safe }};

    const el = document.getElementById("incomeExpenseChart");
    if (!el) return;

    const chart = new Chart(el, {
      type: "line",
      data: {
        labels: labels0,
        datasets: [
          { label: "Income", data: income0, tension: 0.25 },
          { label: "Expenses", data: expenses0, tension: 0.25 }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: "index", intersect: false },
        plugins: { legend: { display: true } },
        scales: {
          y: { ticks: { callback: (value) => "$" + value.toLocaleString() } }
        }
      }
    });

    const modeRolling = document.getElementById("modeRolling");
    const modeYear = document.getElementById("modeYear");
    const yearSelect = document.getElementById("yearSelect");

    const periodLabelEls = [
      document.getElementById("periodLabel"),
      document.getElementById("periodLabel2"),
      document.getElementById("periodLabel3"),
      document.getElementById("chartPeriodLabel"),
    ];

    const incomeTotalEl = document.getElementById("incomeTotal");
    const expenseTotalEl = document.getElementById("expenseTotal");
    const netTotalEl = document.getElementById("netTotal");

    // Default year select to current selected_year_value if it is a year, otherwise first option.
    const initialSelected = "{{ selected_year_value }}";
    if (initialSelected && initialSelected !== "rolling" && yearSelect) {
      yearSelect.value = initialSelected;
      modeYear.checked = true;
      modeRolling.checked = false;
    } else {
      modeRolling.checked = true;
      modeYear.checked = false;
    }

    const setYearEnabled = () => {
      if (!yearSelect) return;
      yearSelect.disabled = modeRolling.checked || yearSelect.options.length === 0;
    };

    async function loadData() {
      const mode = modeRolling.checked ? "rolling" : "year";
      const year = (mode === "year" && yearSelect) ? yearSelect.value : "";
      const url = new URL(chartDataUrl, window.location.origin);
      url.searchParams.set("mode", mode);
      if (mode === "year") url.searchParams.set("year", year);

      try {
        const resp = await fetch(url.toString(), { headers: { "X-Requested-With": "fetch" }});
        if (!resp.ok) return;
        const data = await resp.json();

        // Update KPI totals
        if (incomeTotalEl) incomeTotalEl.textContent = fmtMoney(data.income_total);
        if (expenseTotalEl) expenseTotalEl.textContent = fmtMoney(data.expense_total);
        if (netTotalEl) netTotalEl.textContent = fmtMoney(data.net_total);

        // Update labels
        periodLabelEls.forEach((node) => { if (node) node.textContent = data.period_label || ""; });

        // Update chart
        chart.data.labels = data.labels || [];
        chart.data.datasets[0].data = data.income || [];
        chart.data.datasets[1].data = data.expenses || [];
        chart.update();
      } catch (e) {
        // no-op
      }
    }

    // Wire events
    if (modeRolling) modeRolling.addEventListener("change", () => { setYearEnabled(); loadData(); });
    if (modeYear) modeYear.addEventListener("change", () => { setYearEnabled(); loadData(); });
    if (yearSelect) yearSelect.addEventListener("change", () => { if (modeYear.checked) loadData(); });

    setYearEnabled();
  })();
</script>

{% endblock %}
