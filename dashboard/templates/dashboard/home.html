{% extends "index.html" %}
{% load humanize %}

{% block title %}Dashboard | MoneyPro{% endblock %}

{% block content %}
<div class="container-fluid px-2 px-md-3 py-3">

  <!-- Header -->
  <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-2 mb-3">
    <div>
      <h1 class="h4 mb-0">Dashboard</h1>
      <div class="text-muted small">Welcome back, {{ request.user.email|default:request.user.get_username }}</div>
    </div>

    <!-- Quick actions (mobile-first) -->
    <div class="d-grid d-sm-flex gap-2">
      <a class="btn btn-primary" href="{% url 'ledger:transaction_create' %}">
        <i class="fa-solid fa-plus me-1"></i> Add transaction
      </a>

      <a class="btn btn-outline-primary" href="{% url 'invoices:invoice_create' %}" title="Create Invoice">
        <i class="fa-solid fa-file-invoice-dollar me-1"></i> Create invoice
      </a>

      <a class="btn btn-outline-secondary" href="{% url 'reports:home' %}" title="Reports">
        <i class="fa-solid fa-chart-line me-1"></i> Reports
      </a>

      <button class="btn btn-outline-secondary" type="button" data-bs-toggle="offcanvas" data-bs-target="#dashboardMore" aria-controls="dashboardMore">
        <i class="fa-solid fa-ellipsis me-1"></i> More
      </button>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row g-3 mb-3">
    <div class="col-12 col-md-4">
      <a class="text-decoration-none" href="{% url 'ledger:transaction_list' %}">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="text-muted small">Income (<span id="periodLabel">{{ period_label }}</span>)</div>
            <div class="fs-4 fw-semibold text-body" id="incomeTotal">${{ income_total|floatformat:2|intcomma }}</div>
          </div>
        </div>
      </a>
    </div>

    <div class="col-12 col-md-4">
      <a class="text-decoration-none" href="{% url 'ledger:transaction_list' %}">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="text-muted small">Expenses (<span id="periodLabel2">{{ period_label }}</span>)</div>
            <div class="fs-4 fw-semibold text-body" id="expenseTotal">${{ expense_total|floatformat:2|intcomma }}</div>
          </div>
        </div>
      </a>
    </div>

    <div class="col-12 col-md-4">
      <a class="text-decoration-none" href="{% url 'ledger:transaction_list' %}">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="text-muted small">Net (<span id="periodLabel3">{{ period_label }}</span>)</div>
            <div class="fs-4 fw-semibold text-body" id="netTotal">${{ net_total|floatformat:2|intcomma }}</div>
          </div>
        </div>
      </a>
    </div>
  </div>

  <div class="row g-3">
    <!-- Chart -->
    <div class="col-12 col-lg-7">
      <div class="card shadow-sm h-100">
        <div class="card-body p-3 p-md-4">
          <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-2">
            <div>
              <h2 class="h6 mb-0">Monthly income vs expenses</h2>
              <div class="text-muted small" id="chartPeriodLabel">{{ period_label }}</div>
            </div>

            <!-- Chart controls live with the chart (mobile-first) -->
            <div class="d-flex gap-2 flex-wrap align-items-center">
              <div class="btn-group btn-group-sm" role="group" aria-label="Chart period">
                <input type="radio" class="btn-check" name="periodMode" id="modeRolling" autocomplete="off" checked>
                <label class="btn btn-outline-secondary" for="modeRolling">Rolling 12</label>

                <input type="radio" class="btn-check" name="periodMode" id="modeMonth" autocomplete="off">
                <label class="btn btn-outline-secondary" for="modeMonth">Current Month</label>

                <input type="radio" class="btn-check" name="periodMode" id="modeYear" autocomplete="off">
                <label class="btn btn-outline-secondary" for="modeYear">Year</label>
              </div>

              <label for="yearSelect" class="visually-hidden">Year</label>
              <select id="yearSelect" class="form-select form-select-sm" style="min-width: 120px;" {% if not years %}disabled{% endif %}>
                {% for y in years %}
                  <option value="{{ y }}">{{ y }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="border rounded-3 p-2" style="height: 300px;">
            <canvas id="incomeExpenseChart"></canvas>
          </div>

          <div class="text-muted small mt-3">
            Tip: expenses are shown as positive values (refunds reduce totals).
          </div>
        </div>
      </div>
    </div>

    <!-- Reports -->
    <div class="col-12 col-lg-5">
      <div class="card shadow-sm h-100">
        <div class="card-body p-3 p-md-4">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h2 class="h6 mb-0">Reports</h2>
            <a class="small text-decoration-none" href="{% url 'reports:home' %}">
              All reports <i class="fa-solid fa-arrow-right-long ms-1"></i>
            </a>
          </div>

          <div class="accordion" id="reportsAccordion">
            <div class="accordion-item">
              <h2 class="accordion-header" id="reportsHeading">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#reportsCollapse" aria-expanded="false" aria-controls="reportsCollapse">
                  Report Quick links
                </button>
              </h2>

              <div id="reportsCollapse" class="accordion-collapse collapse" aria-labelledby="reportsHeading" data-bs-parent="#reportsAccordion">
                <div class="accordion-body p-0">

                  <div class="list-group list-group-flush">

                    <!-- Profit & Loss -->
                    <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                       href="{% url 'reports:profit_loss' %}">
                      <span><i class="fa-solid fa-receipt me-2"></i> Profit &amp; Loss Reports</span>
                      <span class="badge text-bg-light">Actual Amounts</span>
                    </a>

                    <div class="list-group-item">
                      <div class="d-flex flex-wrap gap-2">
                        <a class="btn btn-sm btn-outline-secondary" href="{% url 'reports:profit_loss' %}">
                          <i class="fa-solid fa-money-bill-trend-up"></i> P & L</a>
                        <a class="btn btn-sm btn-outline-success" target="_blank" rel="noopener"
                           href="{% url 'reports:profit_loss_yoy' %}">
                          <i class="fa-regular fa-calendar-days"></i> YoY
                        </a>
                        <a class="btn btn-sm btn-outline-primary"
                           href="{% url 'reports:profit_loss_pdf_download' %}">
                          <i class="fa-solid fa-download me-1"></i> Download
                        </a>
                      </div>
                    </div>

                    <!-- Operating Expenses / Schedule C -->
                    <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                       href="{% url 'reports:schedule_c' %}">
                      <span><i class="fa-solid fa-file-invoice me-2"></i>Operating Expenses</span>
                      <span class="badge text-bg-light">Tax / Actual</span>
                    </a>

                    <div class="list-group-item">
                      <div class="d-flex flex-wrap gap-2">
                        <a class="btn btn-sm btn-outline-secondary" href="{% url 'reports:schedule_c' %}">
                          <i class="fa-solid fa-money-bill-trend-up"></i> Expenses</a>
                        <a class="btn btn-sm btn-outline-success" target="_blank" rel="noopener"
                           href="{% url 'reports:schedule_c_yoy' %}">
                           <i class="fa-regular fa-calendar-days"></i> YoY
                        </a>
                        <a class="btn btn-sm btn-outline-primary"
                           href="{% url 'reports:schedule_c_pdf_download' %}">
                          <i class="fa-solid fa-download me-1"></i> Download
                        </a>
                      </div>
                    </div>

                  </div>

                </div>
              </div>
            </div>
          </div>

          <div class="alert alert-light border mt-3 mb-0 small">
            Tip: “Operating Expenses” supports Tax (Deductible) and Books (Actual) modes, plus YoY and PDF.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent transactions -->
  <div class="card shadow-sm mt-3">
    <div class="card-body p-3 p-md-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 mb-0">Recent transactions</h2>
        <a class="small text-decoration-none" href="{% url 'ledger:transaction_list' %}">View all</a>
      </div>

      <!-- Mobile list -->
      <div class="d-md-none">
        <div class="list-group">
          {% for t in recent_transactions %}
            <a class="list-group-item list-group-item-action" href="{% url 'ledger:transaction_update' t.pk %}">
              <div class="d-flex justify-content-between align-items-start gap-2">
                <div class="me-2">
                  <div class="fw-semibold">{{ t.description }}</div>
                  <div class="text-muted small">
                    {{ t.date }}{% if t.team %} · {{ t.team.name }}{% endif %} · {{ t.subcategory.name }}
                  </div>
                </div>
                <div class="text-end text-nowrap">
                  <div class="{% if t.trans_type == 'income' %}text-success{% else %}text-body{% endif %} fw-semibold">
                    {% if t.is_refund %}-{% endif %}${{ t.amount|floatformat:2|intcomma }}
                  </div>
                  {% if t.trans_type == "income" %}<span class="badge rounded-pill text-bg-success">Income</span>{% endif %}
                </div>
              </div>
            </a>
          {% empty %}
            <div class="text-muted small">No transactions yet.</div>
          {% endfor %}
        </div>
      </div>

      <!-- Desktop table -->
      <div class="table-responsive d-none d-md-block">
        <table class="table table-sm align-middle mb-0">
          <thead>
            <tr>
              <th>Date</th>
              <th>Description</th>
              <th>Team</th>
              <th>Subcategory</th>
              <th class="text-end">Amount</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for t in recent_transactions %}
              <tr>
                <td class="text-nowrap">{{ t.date }}</td>
                <td>
                  <div class="d-flex align-items-center gap-2">
                    <div class="fw-semibold">{{ t.description }}</div>
                    {% if t.trans_type == "income" %}<span class="badge rounded-pill text-bg-success">Income</span>{% endif %}
                  </div>
                  <div class="text-muted small">
                    {% if t.team %}{{ t.team.name }} · {% endif %}{{ t.subcategory.name }}
                  </div>
                </td>
                <td>{% if t.team %}{{ t.team.name }}{% else %}—{% endif %}</td>
                <td>{{ t.subcategory.name }}</td>
                <td class="text-end {% if t.trans_type == 'income' %}text-success{% else %}text-body{% endif %}">
                  {% if t.is_refund %}-{% endif %}${{ t.amount|floatformat:2|intcomma }}
                </td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-secondary" href="{% url 'ledger:transaction_update' t.pk %}">
                    <i class="fa-regular fa-pen-to-square"></i>
                    <span class="visually-hidden">Edit</span>
                  </a>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="6" class="text-muted">No transactions yet.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- Offcanvas: More -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="dashboardMore" aria-labelledby="dashboardMoreLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="dashboardMoreLabel">MoneyPro</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">

    <div class="mb-3">
      <div class="text-muted small mb-2">Shortcuts</div>

      {% url 'ledger:job_list' as jobs_url %}
      {% url 'ledger:contact_list' as contacts_url %}

      <div class="list-group">
        <a class="list-group-item list-group-item-action" href="{% url 'ledger:transaction_list' %}">
          <i class="fa-solid fa-list me-2"></i> Transactions
        </a>

        {% if jobs_url %}
          <a class="list-group-item list-group-item-action" href="{{ jobs_url }}">
            <i class="fa-solid fa-briefcase me-2"></i> Jobs
          </a>
        {% else %}
          <a class="list-group-item list-group-item-action disabled" href="#" aria-disabled="true">
            <i class="fa-solid fa-briefcase me-2"></i> Jobs
            <span class="badge text-bg-light ms-2">Soon</span>
          </a>
        {% endif %}

        <a class="list-group-item list-group-item-action" href="{% url 'invoices:invoice_list' %}">
          <i class="fa-solid fa-file-invoice me-2"></i> Invoices
        </a>

        <a class="list-group-item list-group-item-action" href="{% url 'reports:home' %}">
          <i class="fa-solid fa-chart-line me-2"></i> Reports
        </a>

        <a class="list-group-item list-group-item-action disabled" href="#" aria-disabled="true">
          <i class="fa-solid fa-car me-2"></i> Vehicles
          <span class="badge text-bg-light ms-2">Soon</span>
        </a>

        {% if contacts_url %}
          <a class="list-group-item list-group-item-action" href="{{ contacts_url }}">
            <i class="fa-solid fa-address-book me-2"></i> Contacts
          </a>
        {% else %}
          <a class="list-group-item list-group-item-action disabled" href="#" aria-disabled="true">
            <i class="fa-solid fa-address-book me-2"></i> Contacts
            <span class="badge text-bg-light ms-2">Soon</span>
          </a>
        {% endif %}

        <a class="list-group-item list-group-item-action" href="{% url 'ledger:subcategory_list' %}">
          <i class="fa-solid fa-tags me-2"></i> Subcategories
        </a>
      </div>
    </div>

    <hr>

    <div class="mb-3">
      <div class="text-muted small mb-2">Defaults</div>

      <div class="d-grid gap-2">
        <form method="post" action="{% url 'dashboard:seed_defaults' %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-outline-primary w-100">
            {% if has_seeded %}Re-seed defaults{% else %}Seed defaults{% endif %}
          </button>
        </form>

        <form method="post" action="{% url 'dashboard:rebuild_defaults' %}">
          {% csrf_token %}
          <button type="submit"
                  class="btn btn-outline-danger w-100"
                  {% if not can_rebuild %}disabled{% endif %}
                  onclick="return confirm('This will DELETE all categories and subcategories for this business and re-create the defaults. Only allowed when you have no transactions. Continue?');">
            Rebuild defaults
          </button>
          {% if not can_rebuild %}
            <div class="text-muted small mt-1">Rebuild is disabled once you have transactions.</div>
          {% endif %}
        </form>
      </div>
    </div>

  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  (function () {
    const chartDataUrl = "{% url 'dashboard:chart_data' %}";

    const labels0 = {{ chart_labels_json|safe }};
    const income0 = {{ chart_income_json|safe }};
    const expenses0 = {{ chart_expense_json|safe }};

    const el = document.getElementById("incomeExpenseChart");
    if (!el) return;

    const chart = new Chart(el, {
      type: "line",
      data: {
        labels: labels0,
        datasets: [
          { label: "Income", data: income0, tension: 0.25 },
          { label: "Expenses", data: expenses0, tension: 0.25 }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: "index", intersect: false },
        plugins: { legend: { display: true } },
        scales: {
          y: { ticks: { callback: (value) => "$" + value.toLocaleString() } }
        }
      }
    });

    const modeRolling = document.getElementById("modeRolling");
    const modeMonth = document.getElementById("modeMonth");
    const modeYear = document.getElementById("modeYear");
    const yearSelect = document.getElementById("yearSelect");

    const periodLabelEls = [
      document.getElementById("periodLabel"),
      document.getElementById("periodLabel2"),
      document.getElementById("periodLabel3"),
      document.getElementById("chartPeriodLabel"),
    ];

    const incomeTotalEl = document.getElementById("incomeTotal");
    const expenseTotalEl = document.getElementById("expenseTotal");
    const netTotalEl = document.getElementById("netTotal");

    const initialSelected = "{{ selected_year_value }}";

    if (initialSelected === "month") {
      modeMonth.checked = true;
      modeRolling.checked = false;
      modeYear.checked = false;
    } else if (initialSelected && initialSelected !== "rolling" && yearSelect) {
      yearSelect.value = initialSelected;
      modeYear.checked = true;
      modeRolling.checked = false;
      modeMonth.checked = false;
    } else {
      modeRolling.checked = true;
      modeMonth.checked = false;
      modeYear.checked = false;
    }

    async function refreshChart(params) {
      const url = new URL(chartDataUrl, window.location.origin);
      Object.entries(params || {}).forEach(([k, v]) => url.searchParams.set(k, v));

      const res = await fetch(url.toString(), { headers: { "X-Requested-With": "XMLHttpRequest" } });
      if (!res.ok) return;
      const data = await res.json();

      chart.data.labels = data.labels || [];
      chart.data.datasets[0].data = data.income || [];
      chart.data.datasets[1].data = data.expenses || [];
      chart.update();

      if (data.period_label) {
        periodLabelEls.forEach((n) => { if (n) n.textContent = data.period_label; });
      }
      if (incomeTotalEl && data.income_total != null) incomeTotalEl.textContent = "$" + Number(data.income_total).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      if (expenseTotalEl && data.expense_total != null) expenseTotalEl.textContent = "$" + Number(data.expense_total).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      if (netTotalEl && data.net_total != null) netTotalEl.textContent = "$" + Number(data.net_total).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function selectedModeParams() {
      if (modeMonth && modeMonth.checked) return { mode: "month" };
      if (modeYear && modeYear.checked && yearSelect && yearSelect.value) return { mode: "year", year: yearSelect.value };
      return { mode: "rolling" };
    }

    [modeRolling, modeMonth, modeYear].forEach((radio) => {
      if (!radio) return;
      radio.addEventListener("change", () => refreshChart(selectedModeParams()));
    });

    if (yearSelect) {
      yearSelect.addEventListener("change", () => {
        if (modeYear) modeYear.checked = true;
        refreshChart(selectedModeParams());
      });
    }
  })();
</script>
{% endblock %}